# Carat API Backend

FastAPI-based backend for the Carat LGBTQ+ platform.

## üèóÔ∏è Architecture

- **Framework**: FastAPI with Python 3.12
- **Database**: PostgreSQL (AWS RDS Tokyo region)
- **ORM**: SQLAlchemy 2.0
- **Migrations**: Alembic
- **Deployment**: AWS App Runner (via ECR)
- **Package Management**: Poetry

## üóÑÔ∏è Database Configuration

### Production Environment
- **Database**: `lgbtq_community`
- **RDS Instance**: `rainbow-community-db-tokyo` (ap-northeast-1)
- **Connection**: Via AWS Secrets Manager `/rainbow-community-api/DATABASE_URL`

### Staging Environment
- **Database**: `lgbtq_staging`
- **RDS Instance**: Same as production (rainbow-community-db-tokyo)
- **Connection**: Via AWS Secrets Manager `/rainbow-community-api/STAGING_DATABASE_URL`

### Local Development
Configure `.env` file:
```bash
DATABASE_URL=postgresql+psycopg2://dbadmin:password@rainbow-community-db-tokyo.cj8agmy8kjhv.ap-northeast-1.rds.amazonaws.com:5432/lgbtq_community?sslmode=require
SECRET_KEY=your-local-secret-key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080
```

Or use SQLite for quick local testing:
```bash
DATABASE_URL=sqlite:///./lgbtq_community.db
```

## üöÄ Getting Started

### Prerequisites
- Python 3.12+
- Poetry
- PostgreSQL (for local development) or Docker

### Installation

1. Clone the repository:
```bash
git clone https://github.com/tedueda/rainbow_community.git
cd rainbow_community/backend
```

2. Install dependencies:
```bash
poetry install
```

3. Set up environment variables:
```bash
cp .env.example .env
```

4. Run database migrations:
```bash
poetry run alembic upgrade head
```

5. Start the development server:
```bash
poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

6. Access the API:
- API: http://localhost:8000
- Interactive docs: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## üß™ Testing

Run tests with pytest:
```bash
poetry run pytest -v
```

Tests use an in-memory SQLite database by default for fast execution.

## üîÑ Database Migrations

### Create a new migration
```bash
poetry run alembic revision --autogenerate -m "description of changes"
```

### Apply migrations
```bash
poetry run alembic upgrade head
```

### Rollback last migration
```bash
poetry run alembic downgrade -1
```

### View migration history
```bash
poetry run alembic history
```

## üê≥ Docker

Build and run with Docker:
```bash
docker build -t rainbow-api .
docker run -p 8000:8000 --env-file .env rainbow-api
```

## üì¶ Deployment

### CI/CD Pipeline

**API CI** (`.github/workflows/api-ci.yml`):
- Runs on every PR and push to main/develop/devin/** branches
- Uses PostgreSQL service container for testing
- Runs Alembic migrations
- Executes pytest test suite

**Backend Deploy** (`.github/workflows/deploy.yml`):
- Builds Docker image
- Pushes to ECR (Tokyo region)
- App Runner automatically pulls and deploys latest image

### Environments

| Environment | Branch  | App Runner Service          | Database        | Secrets Path                              |
|-------------|---------|-----------------------------|-----------------|--------------------------------------------|
| Production  | main    | rainbow-community-api       | lgbtq_community | /rainbow-community-api/DATABASE_URL        |
| Staging     | develop | rainbow-community-staging   | lgbtq_staging   | /rainbow-community-api/STAGING_DATABASE_URL|

### Manual Deployment

If needed, deploy manually:
```bash
docker build -t rainbow-api .
docker tag rainbow-api:latest <ecr-url>:latest
docker push <ecr-url>:latest
```

## üîê Security

- Database credentials stored in AWS Secrets Manager
- JWT-based authentication for API endpoints
- CORS configured for trusted frontend origins only
- SSL/TLS required for RDS connections
- Security groups restrict database access to App Runner and whitelisted IPs

## üìù API Documentation

Interactive API documentation available at `/docs` when running the server.

Key endpoints:
- `GET /` - API info
- `GET /healthz` - Health check
- `GET /api/health` - Health check with DB verification
- `POST /auth/register` - User registration
- `POST /auth/login` - User login
- `GET /api/posts` - List posts
- And more...

## üõ†Ô∏è Development

### Code Style
- Follow PEP 8
- Use type hints
- Document public functions
- Keep functions focused and small

### Database Models
Located in `app/models.py`. Key tables:
- users, profiles
- posts, comments, reactions
- tags, follows
- content_items, reviews
- awards, point_events

## üêõ Troubleshooting

### Connection Issues
- Verify security group allows your IP for RDS access
- Check Secrets Manager has correct DATABASE_URL
- Ensure SSL mode is set (`?sslmode=require`)

### Migration Issues
- Always review autogenerated migrations before applying
- Test migrations on staging before production
- Keep migration files in version control

### Test Failures
- Ensure test database is clean (migrations applied)
- Check environment variables are set correctly
- Review test output for specific errors

## üìö Additional Resources

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [AWS App Runner Documentation](https://docs.aws.amazon.com/apprunner/)
